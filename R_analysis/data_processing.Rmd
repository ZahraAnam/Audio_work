---
title: "audio processing"
output: html_document
---

```{r}
read_rttm <- function(x,
                      from = NULL,
                      to = NULL) {
  if (length(readLines(x)) > 0) {
    res <- read.table(x, header = FALSE)
    colnames(res)[c(4, 5, 8)] <- c("start", "duration", "tier")
    res$end <- res$start + res$duration
  } else {
    res <- matrix(0, nrow = 0, ncol = 10)
    # res[1, ] <- NA
    colnames(res) <- paste0("V", 1:ncol(res))
    colnames(res)[c(4, 5, 8, 10)] <- c("start", "duration", "tier", "end")
    res <- data.frame(res)
  }

  if (!is.null(from)) {
    res <- res[res$end > from, ]
    if (nrow(res) > 0) {
      if (res$start[1] < from) {
        res$start[1] <- from
        res$duration[1] <- res$end[1] - res$start[1]
      }
    }
  }

  if (!is.null(to)) {
    res <- res[res$start < to, ]
    if (nrow(res) > 0) {
      if (res$end[nrow(res)] > to) {
        res$end[nrow(res)] <- to
        res$duration[nrow(res)] <- res$end[nrow(res)] - res$start[nrow(res)]
      }
    }
  }


  attributes(res)$filename <- basename(x)
  rownames(res) <- NULL
  res
}
```

```{r}
library(tidyverse)
library(ggthemes)
```

# Read data

```{r setup, include=FALSE}

files <- list.files(path = "../Data",pattern = "all.rttm", recursive = TRUE)%>%
  str_subset(pattern = c("00000_00000020201016142243_0001A/all.rttm","191016_1319/all.rttm"), negate = T)

raw_data <- data_frame()
for (f in files) {
  jd <- read_rttm(paste("../Data/",f,sep=""))
  source <- str_sub(f,-14,-10)
  id <- str_sub(f,13,18)
  data <- jd %>% mutate(id = id, source = source)
  raw_data <- bind_rows(raw_data, data)
}

```

# Visualize by tier and source

```{r}
ggplot(raw_data, aes(x = tier, ymin = start, ymax = end, col = source))+
  geom_linerange(position = position_dodge(width = 0.9), size = 4)+
  coord_flip()+
  #geom_segment(aes(x = start, y = tier, xend = end, yend = tier), size = 5, position = posi)+
  theme_minimal()+
  facet_grid(id~.)+
  #ylim(0,100)+
  scale_color_ptol()

ggsave("./plots/audio_video_comparison.png", width = 12, height = 16, scale = 1)
```

